<link rel="import" href="{$components_url}bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="{$components_url}bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="{$components_url}bower_components/paper-material/paper-material.html">
<link rel="import" href="{$components_url}bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="{$components_url}bower_components/iron-icons/iron-icons.html">
<link rel="import" href="{$components_url}bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="{$components_url}datalets/graph-datalet/graph-datalet.html">

<style is="custom-style">

    paper-toolbar.toolbar-main
    {
        --paper-toolbar-background:#2196F3;
        -moz-box-shadow: 0 0 20px 5px #999;
        -webkit-box-shadow: 0 0 20px 5px #999;
        z-index : 100;
        height: 40px;
    }
    paper-toolbar.title-header{
        --paper-toolbar-background:#2196F3;
        -moz-box-shadow: 0 0 20px 5px #999;
        -webkit-box-shadow: 0 0 20px 5px #999;
        margin-bottom: 10px;
        height: 30px;
    }
    paper-fab{
        --paper-fab-background:#2196F3;
    }
    paper-fab.show_datalet{
        --iron-icon-height: 18px;
        --iron-icon-width:  18px;
        height: 22px;
        width:  22px;
    }

    paper-header-panel{
        /*height: 8vh;;*/
    }

    .title h4{
        color: #ffffff;
    }

    paper-toolbar.toolbar-graph
    {
        --paper-toolbar-background:#2196F3;
        -moz-box-shadow: 0 0 20px 5px #999;
        -webkit-box-shadow: 0 0 20px 5px #999;
        height: 35px;
        z-index: 100;
        margin-left: 10px;
        margin-right: 10px;
    }

    ::content paper-toolbar div#topBar {
        height: 35px;
    }

    #graph_container{
        margin-top: 25px;
        width: 48%;
        display: none;

    }

    #graph_content{
        position: relative;
        overflow: auto;
        height: 80vh;
    }

    #topic_container{
        position: relative;
        overflow: auto;
        height: 93vh;
        width: 100%;
        margin-left: 30px;
    }

    #pr_body{
        font-family: 'Roboto', sans-serif;
        display: inline-block;
        color: #6c6c6c;
        font-weight: bolder;
        font-size: 20px;
        margin: 30px;
        padding-bottom: 50px;
        padding-right: 10px;
        padding-left: 10px;
        font-style: italic;
        margin-top: 25px;
    }

    .q-comments{
        padding-left: 30px;
        width: 90%;
    }
</style>

{style}
#button_container { display: none; }

body .floatbox_canvas .floatbox_container{ margin-top:10px; }
{/style}

{literal}
<script>

    var selected_graph        = null;
    var last_selected_element = null;

    window.addEventListener('graph-datalet_node-clicked', function(e){
        if(last_selected_element != null){
            last_selected_element.css('border', 'none');
            last_selected_element.css('font-weight', 'normal');
        }

        if(e.detail.node.id == 0) return;

        var curr_element = $("#comment_" + e.detail.node.originalId);
        $(curr_element).css('border', '1px solid #000000');
        $(curr_element).css('font-weight', 'bold');

        $('div[id^="nc_"]').css('display', 'none');
        $(curr_element).parents('div[id^="nc_"]').css('display', 'block');

        $("#topic_container").scrollTop($(curr_element).offset().top);

        last_selected_element = curr_element;
    });

    slideGraphPanel = function(){
        $('#graph_container').toggle('slide', {direction: 'right'}, 300, function(){
            $('#topic_container').css('width' , ($('#graph_container').css('display') == 'none') ? '100%' : '50%');
        });
    };

    dataletGraphShow = function(){
        selected_graph = "datalet";
        $.post( SPODPUBLICROOM.get_graph_url,
                {
                    id : SPODPUBLICROOM.public_room_id,
                    type : "datalets"
                },
                function(data, status){
                    data = JSON.parse(data);
                    if(data.status == "ok"){
                        $("#graph_content").html('<graph-datalet data=\'' + data.graph + '\'></graph-datalet>');
                        $("#toolbar-graph-title").html('Datalet graph');
                        $("#datalet_graph").css('border-bottom-style','solid');
                        $("#comment_graph").css('border-bottom-style','none');
                        $("#user_graph").css('border-bottom-style','none');
                    }
                }
        );
    };

    commentGraphShow = function(){
        selected_graph = "comment";
        $.post( SPODPUBLICROOM.get_graph_url,
                {
                    id : SPODPUBLICROOM.public_room_id,
                    type : "comments"
                },
                function(data, status){
                    data = JSON.parse(data);
                    if(data.status == "ok"){
                        $("#graph_content").html("<graph-datalet data='" + data.graph + "'></graph-datalet>");
                        $("#toolbar-graph-title").html('Comments graph');
                        $("#comment_graph").css('border-bottom-style','solid');
                        $("#datalet_graph").css('border-bottom-style','none');
                        $("#user_graph").css('border-bottom-style','none');
                    }
                }
        );
    }

    usersGraphShow = function(){
        selected_graph = "users";
        $.post( SPODPUBLICROOM.get_graph_url,
                {
                    id : SPODPUBLICROOM.public_room_id,
                    type : "users"
                },
                function(data, status){
                    data = JSON.parse(data);
                    if(data.status == "ok"){
                        $("#graph_content").html("<graph-datalet data='" + data.graph + "'></graph-datalet>");
                        $("#toolbar-graph-title").html('Users graph');
                        $("#user_graph").css('border-bottom-style','solid');
                        $("#comment_graph").css('border-bottom-style','none');
                        $("#datalet_graph").css('border-bottom-style','none');
                    }
                }
        );
    };

    $(document).ready(function () {
        $('#topic_container').perfectScrollbar();
        $('#graph_content').perfectScrollbar();

        OW.bind('base.comment_added', function(e){
            switch(selected_graph){
                case "comment":
                    commentGraphShow();
                    break;
                case "datalet":
                    dataletGraphShow();
                    break;
                case "users":
                    usersGraphShow();
                    break;
            }
        });

        OW.bind('base.comment_delete', function(e){
            switch(selected_graph){
                case "comment":
                    commentGraphShow();
                    break;
                case "datalet":
                    dataletGraphShow();
                    break;
                case "users":
                    usersGraphShow();
                    break;
            }
        });
    });

    $(window).load(function() {
        commentGraphShow();
        slideGraphPanel();
    });

</script>
{/literal}

<paper-header-panel>
    <paper-toolbar class="toolbar-main">
        <div class="title"><h4>{$public_room->subject}</h4></div>
        <paper-icon-button paper-drawer-toggle icon="language" onClick="slideGraphPanel()"></paper-icon-button>
    </paper-toolbar>
</paper-header-panel>

<div class="layout horizontal">
    <paper-material id="topic_container" class="layout vertical justified">
        <paper-material elevation="0" id="pr_body">
            <paper-toolbar class="title-header"><h6 style="color:#ffffff;">About this topic</h6></paper-toolbar>
            {$public_room->body}
        </paper-material>
        {if !empty($comments)}
        <div class="q-comments">
            {$comments}
        </div>
        {/if}
    </paper-material>

    <paper-material elevation="1" animated id="graph_container">
        <paper-toolbar class="toolbar-graph">
            <paper-icon-button id="datalet_graph" paper-drawer-toggle icon="assessment" onClick="dataletGraphShow()"></paper-icon-button>
            <paper-icon-button id="comment_graph" paper-drawer-toggle icon="speaker-notes" onClick="commentGraphShow()"></paper-icon-button>
            <paper-icon-button id="user_graph" paper-drawer-toggle icon="account-circle" onClick="usersGraphShow()"></paper-icon-button>
            <h5 id="toolbar-graph-title" style="color: #ffffff;margin-left: 30px;">Comments graph</h5>
        </paper-toolbar>
        <div id="graph_content">
        </div>
    </paper-material>
</div>

<!-- ODE PRIVATE-ROOM -->
<div>
    {if isset($private_room)}
    {$private_room}
    {/if}
</div>
<!-- ODE PRIVATE-ROOM -->